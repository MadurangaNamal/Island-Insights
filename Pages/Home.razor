@page "/"
@inject INewsService NewsService

<PageTitle>Island Insights</PageTitle>

<div class="container mt-4">  
    <h2 class="text-center text-warning fw-semibold fs-3 mb-2">
        📰 News Sources - Sri Lanka
    </h2>
    <p class="text-center text-white fs-6 mb-4">
        Explore trusted news publishers across the island
    </p>

    @if (isLoading && newsData == null)
    {
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <p>Loading news sources...</p>
        </div>
    }
    else if (newsData?.Results is { Count: > 0 })
    {
        <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-4">
            @foreach (var source in newsData.Results)
            {
                <div class="col">
                    <div class="card h-100 news-card shadow-sm border-0">
                        <div class="card-body d-flex">
                            @if (!string.IsNullOrWhiteSpace(source.Icon))
                            {
                                <img src="@source.Icon" class="news-icon me-3" alt="@source.Name icon" />
                            }
                            <div>
                                <h5 class="card-title text-dark-emphasis">@source.Name</h5>
                                <p class="card-text text-body-emphasis">@source.Description</p>
                            </div>
                        </div>
                        <div class="card-footer bg-danger-subtle border-0 text-end">
                            <a href="@source.Url" class="btn btn-outline-primary btn-sm" target="_blank">
                                Visit Source
                            </a>
                        </div>
                    </div>
                </div>
            }
        </div>

        @if (!string.IsNullOrEmpty(newsData.NextPage))
        {
            <div class="text-center mt-4">
                <button class="btn btn-primary" @onclick="LoadMore" disabled="@isLoading">
                    @(isLoading ? "Loading..." : "Load More")
                </button>
            </div>
        }
    }
    else
    {
        <p class="text-muted">No news sources found.</p>
    }
</div>

<style>
    .news-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
        border-radius: 0.75rem;
        background-color: cornflowerblue;
        border-left: 5px solid #0d6efd;
    }

        .news-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            background-color: burlywood;
        }

    .news-icon {
        width: 60px;
        height: 60px;
        object-fit: contain;
        flex-shrink: 0;
    }

    .news-card .card-body {
        min-height: 160px;
    }

    .card-title {
        font-weight: 600;
    }

    .card-text {
        font-size: 0.95rem;
        font-family: Arial, sans-serif;
    }
</style>

@code {
    private NewsSourcesApiResponse? newsData;
    private string? nextPage;
    private string countryCode = "LK";
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadNews();
    }

    private async Task LoadNews(string? page = null)
    {
        isLoading = true;
        var result = await NewsService.GetNewsSourcesAsync(countryCode, page);

        if (newsData == null || string.IsNullOrEmpty(page))
        {
            newsData = result;
        }
        else
        {
            newsData.Results.AddRange(result.Results);
            newsData.NextPage = result.NextPage;
        }

        nextPage = result.NextPage;
        isLoading = false;
    }

    private async Task LoadMore()
    {
        if (!string.IsNullOrEmpty(nextPage))
        {
            await LoadNews(nextPage);
        }
    }
}